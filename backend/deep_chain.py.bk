"""
Jarvis DeepAgent system built on top of the deepagents framework.
"""
from deepagents import create_deep_agent   # ← imported from the library
from backend.multi_mcp_client import get_langchain_tools
from backend.subagents import create_domain_subagents
from backend.models import MCPServerConfig
from backend.utils import fetch_mcp_prompt
from typing import List
import logging
from langchain_openai import ChatOpenAI

logger = logging.getLogger(__name__)

def create_jarvis_deep_agent(mcp_servers: List[MCPServerConfig]):
    """
    Bootstraps the full DeepAgents hierarchy:
      - Creates subagents per MCP domain
      - Registers them in the orchestrator
    """
    all_tools = get_langchain_tools(mcp_servers)

    subagents = create_domain_subagents(all_tools, mcp_servers)

    orchestrator_prompt = """
    You are Jarvis, a DeepAgent orchestrator.
    - Break down the user's goal into subtasks.
    - Assign each subtask to the correct subagent.
    - Manage the order of execution and context passing.
    - Finally, synthesize a unified answer.
    """

    # 4️⃣ Create orchestrator via DeepAgents library
    model = ChatOpenAI(model="gpt-4o-mini", temperature=0.3),
    jarvis = create_deep_agent(
        name="jarvis_orchestrator",
        model=model,
        subagents=subagents,
        system_prompt=orchestrator_prompt,
    )

    return jarvis

